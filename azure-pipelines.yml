
trigger:
- main

jobs:
- job: CI
  workspace:
    clean: all
    
  pool:
    name: nitsm-python-test

  steps:
  - script: |
      python -m pip install --upgrade pip
    displayName: 'Upgrade pip'

  # if uninstall.txt is empty, pip will exit with an error
  # uninstall with requirements file first as assurance required packages are removed from global
  - script: |
      pip uninstall -r requirements.txt
    displayName: 'Uninstall requirements from global packages'

  # then, attempt to remove any remaining global packages and continue on error
  - script: |
      pip freeze > uninstall.txt
      pip uninstall -r uninstall.txt
    continueOnError: true
    displayName: 'Uninstall remaining global packages'

  - script: |
      pip install --upgrade virtualenv
    displayName: 'Install virtualenv'

  - script: |
      virtualenv venv
    displayName: 'Create virtual environment'

  - script: |
      call venv\Scripts\activate.bat
      pip install  --upgrade -r requirements.txt
    displayName: 'Install requirements to virtual environment'

  - script: |
      call venv\Scripts\activate.bat
      pip install . --no-cache
    displayName: 'Install nitsm to virtual environment'

  - script: |
      call venv\Scripts\activate.bat
      pytest tests systemtests --junitxml=test-results.xml --cov=nitsm --cov-report=xml
    displayName: 'Run python unit tests'

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFiles: '**/test-results.xml'
      testRunTitle: 'Publish test results'
    displayName: 'Display test results'

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
    displayName: 'Display code coverage results'
