
trigger:
- main

jobs:
- job: CI
  workspace:
    clean: all
    
  pool:
    name: nitsm-python-test

  steps:
  - script: |
      pip install --upgrade virtualenv
      virtualenv venv
      call venv\Scripts\activate.bat
      pip install -r requirements.txt --no-cache
    displayName: 'Provision virtual environment'

  - script: |
      call venv\Scripts\activate.bat
      pip install .
    displayName: 'Install nitsm-python'

  - script: |
      call venv\Scripts\activate.bat
      pytest tests systemtests --junitxml=test-results.xml --cov=nitsm --cov-report=xml
    displayName: 'Run python unit tests'

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFiles: '**/test-results.xml'
      testRunTitle: 'Publish test results'
    displayName: 'Display test results'

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
    displayName: 'Display code coverage results'
